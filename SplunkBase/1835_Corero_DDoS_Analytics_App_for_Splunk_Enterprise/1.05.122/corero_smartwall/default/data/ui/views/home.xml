<form>
    <label>Home</label>
    <description>Security and network activity for a site, showing peak rates during the chosen time frame.  Select a site and the desired time frame and click Submit.</description>
    <fieldset autoRun="false">
        <input type="dropdown" token="deployment">
            <label>Site</label>
            <populatingSearch fieldForValue="query" fieldForLabel="description">
                <![CDATA[| rest /services/authentication/current-context splunk_server=local | fields + username | lookup sites user as username OUTPUT user, description, query | append [ | rest /services/authentication/current-context splunk_server=local | eval username="all" | lookup sites user as username OUTPUT user, description, query ] | eval myzip=mvzip(description, query) | table myzip | mvexpand myzip | rex field=myzip "(?<description>[^,]+),(?<query>[^,]+)" | fields - myzip | sort description]]>
            </populatingSearch>
            <selectFirstChoice>true</selectFirstChoice>
        </input>
        <input type="time">
            <label>Time Frame</label>
            <default>
                <earliestTime>@d</earliestTime>
                <latestTime>now</latestTime>
            </default>
        </input>
        <input type="dropdown" token="mytz" depends="$hidden$">
            <label>mytz</label>
            <populatingSearch fieldForValue="tz">
                <![CDATA[$deployment$ | head 1 | eval tz=strftime(_time,"%Z") | table tz]]>
            </populatingSearch>
            <selectFirstChoice>true</selectFirstChoice>
        </input>
    </fieldset>
    <row>
        <chart>
            <title>Link Utilization</title>
            <searchString>
$deployment$ cat=network type=interface
| bucket 1m
| stats sum(epbrr) as epbrr sum(ipbtr) as ipbtr sum(epbtr) as epbtr sum(ipbrr) as ipbrr by _time
| eval gb_epbrr=epbrr/1000
| eval gb_ipbtr=ipbtr/1000
| eval gb_epbtr=epbtr/1000
| eval gb_ipbrr=ipbrr/1000
| timechart partial=f `myspan` max(gb_epbrr) as "From Internet" max(gb_ipbtr) as "To Protected" max(gb_ipbrr) as "From Protected" max(gb_epbtr) as "To Internet"
            </searchString>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.nullValueMode">zero</option>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
            <option name="charting.axisTitleX.text">Time ($mytz$)</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="resizable">true</option>
            <option name="charting.chart">line</option>
            <option name="charting.data.count">1500</option>
            <option name="charting.axisTitleY.text">Gbps</option>
            <option name="charting.drilldown">off</option>
            <option name="link.inspectSearch.visible">true</option>
            <option name="link.openSearch.visible">true</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.chart.style">shiny</option>
        </chart>
        <chart>
            <title>Flow Usage</title>
            <searchString>
$deployment$ cat=network type=usage
| bucket 1m
| stats sum(iuf) as iuf sum(iutf) as iutf sum(iuuf) as iuuf sum(iuif) as iuif sum(iuof) as iuof by _time
| timechart partial=f `myspan` max(iuf) as "Total Flows" max(iutf) as "TCP Flows" max(iuuf) as "UDP Flows" max(iuif) as "ICMP Flows" max(iuof) as "All Other IP Flows"
            </searchString>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.nullValueMode">zero</option>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
            <option name="charting.axisTitleX.text">Time ($mytz$)</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="resizable">true</option>
            <option name="charting.chart">line</option>
            <option name="charting.data.count">1500</option>
            <option name="charting.axisTitleY.text">Number of Flows</option>
            <option name="charting.drilldown">off</option>
            <option name="link.inspectSearch.visible">true</option>
            <option name="link.openSearch.visible">true</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.chart.style">shiny</option>
        </chart>
        </row>
        <row>
            <chart>
                <title>Packets per Second</title>
                <searchString>
$deployment$ cat=network type=interface
| bucket 1m
| stats sum(epprr) as epprr sum(ipptr) as ipptr sum(ipprr) as ipprr sum(epptr) as epptr by _time
| timechart partial=f `myspan` max(epprr) as "From Internet" max(ipptr) as "To Protected" max(ipprr) as "From Protected" max(epptr) as "To Internet"
                </searchString>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.nullValueMode">zero</option>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
            <option name="charting.axisTitleX.text">Time ($mytz$)</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="resizable">true</option>
            <option name="charting.chart">line</option>
            <option name="charting.data.count">1500</option>
            <option name="charting.axisTitleY.text">Packets per Second</option>
            <option name="charting.drilldown">off</option>
            <option name="link.inspectSearch.visible">true</option>
            <option name="link.openSearch.visible">true</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.chart.style">shiny</option>
        </chart>
        <chart>
            <title>Setup Rates</title>
            <searchString>
$deployment$ cat=network type=setups
| bucket 1m
| stats sum(tsr) as tsr sum(usr) as usr sum(isr) as isr sum(oisr) as oisr by _time
| eval total=tsr+usr+isr+oisr
| where total>0
| timechart partial=f `myspan` max(total) as "Total Setups" max(tsr) as "TCP Setups" max(usr) as "UDP Setups" max(isr) as "ICMP Setups" max(oisr) as "All Other IP Setups"
            </searchString>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.nullValueMode">zero</option>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
            <option name="charting.axisTitleX.text">Time ($mytz$)</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="resizable">true</option>
            <option name="charting.chart">line</option>
            <option name="charting.data.count">1500</option>
            <option name="charting.axisTitleY.text">Setups per Second</option>
            <option name="charting.drilldown">off</option>
            <option name="link.inspectSearch.visible">true</option>
            <option name="link.openSearch.visible">true</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.chart.style">shiny</option>
        </chart>
    </row>
    <row>
        <chart>
            <title>Top 10 Rule Types Blocked</title>
            <searchString>
$deployment$ cat=security type=rule-stats
| bucket 1m
| stats sum(bpr) as bpr by name _time
| timechart partial=f `myspan` max(bpr) by name
            </searchString>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.nullValueMode">zero</option>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
            <option name="charting.axisTitleX.text">Time ($mytz$)</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="resizable">true</option>
            <option name="charting.chart">line</option>
            <option name="charting.data.count">1500</option>
            <option name="charting.axisTitleY.text">Packets per Second</option>
            <option name="charting.drilldown">off</option>
            <option name="link.inspectSearch.visible">true</option>
            <option name="link.openSearch.visible">true</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.chart.style">shiny</option>
        </chart>
        <chart>
            <title>Top 10 Rule Types Detected</title>
            <searchString>
$deployment$ cat=security type=rule-stats
| bucket 1m
| stats sum(dpr) as dpr by name _time
| timechart partial=f `myspan` max(dpr) by name
            </searchString>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.nullValueMode">zero</option>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisNone</option>
            <option name="charting.axisTitleX.text">Time ($mytz$)</option>
            <option name="charting.legend.placement">right</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="resizable">true</option>
            <option name="charting.chart">line</option>
            <option name="charting.data.count">1500</option>
            <option name="charting.axisTitleY.text">Packets per Second</option>
            <option name="charting.drilldown">off</option>
            <option name="link.inspectSearch.visible">true</option>
            <option name="link.openSearch.visible">true</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.chart.style">shiny</option>
        </chart>
    </row>


    <row>
        <table>
            <title>Blocked Events</title>
            <searchString>
$deployment$ cat=security type=rule-stats
| stats max(bec) as maxbec min(bec) as minbec max(bpc) as maxbpc min(bpc) as minbpc  by cl name
| stats sum(maxbec) sum(maxbec) as maxbec sum(minbec) as minbec sum(maxbpc) as maxbpc sum(minbpc) as minbpc  by name
| eval deltabec = maxbec-minbec
| eval deltabpc = maxbpc-minbpc
| lookup smartwallrules name as name OUTPUT description
| table name, description, deltabec, deltabpc
| sort - deltabec
| rename name AS Rule description as Description deltabec as "Blocked Events" deltabpc as "Blocked Packets"
            </searchString>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="charting.chart">line</option>
            <option name="charting.chart.nullValueMode">gaps</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.style">shiny</option>
            <option name="charting.drilldown">all</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
            <option name="charting.legend.placement">right</option>
            <option name="wrap">true</option>
            <option name="rowNumbers">false</option>
            <option name="dataOverlayMode">none</option>
            <option name="drilldown">cell</option>
            <drilldown>
                <link>
<![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.corero_rule=$row.Rule$&form.deployment=$deployment$&form.myDNSLookup=$myDNSLookup$
]]>
                </link>
            </drilldown>
        </table>
        <table>
            <title>Detected Events</title>
            <searchString>
$deployment$ cat=security type=rule-stats
| stats max(dec) as maxdec min(dec) as mindec max(dpc) as maxdpc min(dpc) as mindpc by cl name
| stats sum(maxdec) as maxdec sum(mindec) as mindec sum(maxdpc) as maxdpc sum(mindpc) as mindpc by name
| eval deltadec = maxdec-mindec
| eval deltadpc = maxdpc-mindpc
| lookup smartwallrules name as name OUTPUT description
| table name, description, deltadec, deltadpc
| sort - deltadec
| rename name AS Rule description as Description  deltadec as "Detected Events" deltadpc as "Detected Packets"
            </searchString>
            <option name="charting.axisTitleX.visibility">visible</option>
            <option name="charting.axisTitleY.visibility">visible</option>
            <option name="charting.axisX.scale">linear</option>
            <option name="charting.axisY.scale">linear</option>
            <option name="charting.chart">line</option>
            <option name="charting.chart.nullValueMode">gaps</option>
            <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
            <option name="charting.chart.stackMode">default</option>
            <option name="charting.chart.style">shiny</option>
            <option name="charting.drilldown">all</option>
            <option name="charting.layout.splitSeries">0</option>
            <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
            <option name="charting.legend.placement">right</option>
            <option name="wrap">true</option>
            <option name="rowNumbers">false</option>
            <option name="dataOverlayMode">none</option>
            <option name="drilldown">cell</option>
            <drilldown>
                <link>
<![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.corero_rule=$row.Rule$&form.deployment=$deployment$&form.myDNSLookup=$myDNSLookup$
]]>
                </link>
            </drilldown>
        </table>
    </row>
</form>
