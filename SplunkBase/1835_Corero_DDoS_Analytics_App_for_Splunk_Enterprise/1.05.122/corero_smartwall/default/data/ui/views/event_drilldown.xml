<form>
  <label>Security Drilldown</label>
  <description>Advanced security and network parameters for a site.  Select a site and click Search. Use search fields to refine your results.</description>
  <fieldset autoRun="false">
        <input type="dropdown" token="deployment">
            <label>Site</label>
            <populatingSearch fieldForValue="query" fieldForLabel="description">
                <![CDATA[| rest /services/authentication/current-context splunk_server=local | fields + username | lookup sites user as username OUTPUT user, description, query | append [ | rest /services/authentication/current-context splunk_server=local | eval username="all" | lookup sites user as username OUTPUT user, description, query ] | eval myzip=mvzip(description, query) | table myzip | mvexpand myzip | rex field=myzip "(?<description>[^,]+),(?<query>[^,]+)" | fields - myzip | sort description]]>
            </populatingSearch>
            <selectFirstChoice>true</selectFirstChoice>
        </input>
    <input type="time">
      <label>Time Frame</label>
      <default>
        <earliestTime>@d</earliestTime>
        <latestTime>now</latestTime>
      </default>
    </input>
    <input type="dropdown" token="myDir">
      <label>Direction</label>
      <choice value="*">Inbound and Outbound</choice>
      <choice value="inbound">Inbound</choice>
      <choice value="outbound">Outbound</choice>
      <default>Inbound</default>
    </input>
    <input type="dropdown" token="myAct">
      <label>Action</label>
      <choice value="*">Blocked and Detected</choice>
      <choice value="block">Blocked</choice>
      <choice value="detect">Detected</choice>
      <default>Blocked and Detected</default>
    </input>
      <input type="dropdown" token="myDNSLookup">
      <label>DNS Lookup</label>
      <choice value="dnslookup">Yes</choice>
      <choice value="dnslookupNULL">No</choice>
      <default>No</default>
    </input>
    <input type="text" token="my_cust">
      <label>Customer</label>
      <default>*</default>
    </input>
    <input type="text" token="server_group">
      <label>Server Group</label>
      <default>*</default>
    </input>
    <input type="text" token="corero_rule">
      <label>Corero Rule</label>
      <default>*</default>
    </input>
    <input type="text" token="myProt">
      <label>IP Protocol Number</label>
      <default>*</default>
    </input>
    <input type="text" token="packet_length">
      <label>Packet Length</label>
      <default>*</default>
    </input>
    <input type="text" token="server_IP">
      <label>Server IP Address</label>
      <default>*</default>
    </input>
    <input type="text" token="server_port">
      <label>Server Port</label>
      <default>*</default>
    </input>
    <input type="text" token="client_IP">
      <label>Client IP Address</label>
      <default>*</default>
    </input>
    <input type="text" token="client_port">
      <label>Client Port</label>
      <default>*</default>
    </input>
  </fieldset>
  <row>
    <table>
      <title>Blocked Events</title>
      <searchString>
$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=block srvgrp=$server_group$  plen=$packet_length$ cust=$my_cust$
| eval inbound_blocked = if(act="block" AND dir="inbound",1,0)
| eval outbound_blocked = if(act="block" AND dir="outbound",1,0)
| stats sparkline(count(rule),10m) as sparkline sum(inbound_blocked) as "Inbound Blocked Events",  sum(outbound_blocked) as "Outbound Blocked Events" dc(sip) as "Clients Seen" dc(dip) as "Servers Accessed" dc(dprt) as "Protocols Used" by rule
| lookup smartwallrules name as rule OUTPUT description as Description
| eval Description=if (Description="","*Unknown*",Description)
| table rule, Description, "Inbound Blocked Events", "Outbound Blocked Events", "Servers Accessed", "Clients Seen", "Protocols Used", sparkline
| sort - "Inbound Blocked Events"
| rename rule AS Rule, sparkline as "Blocked Rule Activity Sparkline"
    </searchString>
      <option name="charting.axisTitleX.visibility">visible</option>
      <option name="charting.axisTitleY.visibility">visible</option>
      <option name="charting.axisX.scale">linear</option>
      <option name="charting.axisY.scale">linear</option>
      <option name="charting.chart">line</option>
      <option name="charting.chart.nullValueMode">gaps</option>
      <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
      <option name="charting.chart.stackMode">default</option>
      <option name="charting.chart.style">shiny</option>
      <option name="charting.drilldown">all</option>
      <option name="charting.layout.splitSeries">0</option>
      <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
      <option name="charting.legend.placement">right</option>
      <option name="wrap">true</option>
      <option name="rowNumbers">false</option>
      <option name="dataOverlayMode">none</option>
      <option name="drilldown">cell</option>
      <format type="sparkline" field="Blocked Rule Activity Sparkline">
        <option name="maxSpotColor">#A2FFA2</option>
        <option name="lineWidth">1</option>
        <option name="height">25px</option>
        <option name="spotRadius">3</option>
        <option name="fillColor">#CCDDFF</option>
        <option name="lineColor">#5379af</option>
      </format>
      <drilldown>
        <link>
<![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.server_IP=$server_IP$&form.deployment=$deployment$&form.client_IP=$client_IP$&form.corero_rule=$row.Rule$&form.server_port=$server_port$&form.myProt=$myProt$&form.client_port=$client_port$&form.myDir=$myDir$&form.myAct=$myAct$&form.server_group=$server_group$&form.packet_length=$packet_length$&form.myDNSLookup=$myDNSLookup$&form.my_cust=$my_cust$
]]>
        </link>
      </drilldown>
    </table>
  </row>
  <row>
    <table>
      <title>Detected Events</title>
      <searchString>
$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=detect srvgrp=$server_group$  plen=$packet_length$ cust=$my_cust$
| eval inbound_detected = if(act="detect" AND dir="inbound",1,0)
| eval outbound_detected = if(act="detect" AND dir="outbound",1,0)
| stats sparkline(count(rule),10m) as sparkline sum(inbound_detected) as "Inbound Detected Events",  sum(outbound_detected) as "Outbound Detected Events" dc(sip) as "Clients Seen" dc(dip) as "Servers Accessed" dc(dprt) as "Protocols Used" by rule
| lookup smartwallrules name as rule OUTPUT description as Description
| eval Description=if (Description="","*Unknown*",Description)
| table rule, Description, "Inbound Detected Events", "Outbound Detected Events", "Servers Accessed", "Clients Seen", "Protocols Used", sparkline
| sort - "Inbound Detected Events"
| rename rule AS Rule, sparkline as "Detected Rule Activity Sparkline"
    </searchString>
      <option name="charting.axisTitleX.visibility">visible</option>
      <option name="charting.axisTitleY.visibility">visible</option>
      <option name="charting.axisX.scale">linear</option>
      <option name="charting.axisY.scale">linear</option>
      <option name="charting.chart">line</option>
      <option name="charting.chart.nullValueMode">gaps</option>
      <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
      <option name="charting.chart.stackMode">default</option>
      <option name="charting.chart.style">shiny</option>
      <option name="charting.drilldown">all</option>
      <option name="charting.layout.splitSeries">0</option>
      <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
      <option name="charting.legend.placement">right</option>
      <option name="wrap">true</option>
      <option name="rowNumbers">false</option>
      <option name="dataOverlayMode">none</option>
      <option name="drilldown">cell</option>
      <format type="sparkline" field="Detected Rule Activity Sparkline">
        <option name="maxSpotColor">#A2FFA2</option>
        <option name="lineWidth">1</option>
        <option name="height">25px</option>
        <option name="spotRadius">3</option>
        <option name="fillColor">#CCDDFF</option>
        <option name="lineColor">#5379af</option>
      </format>

      <drilldown>
        <link>
<![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.server_IP=$server_IP$&form.deployment=$deployment$&form.client_IP=$client_IP$&form.corero_rule=$row.Rule$&form.server_port=$server_port$&form.myProt=$myProt$&form.client_port=$client_port$&form.myDir=$myDir$&form.myAct=$myAct$&form.server_group=$server_group$&form.packet_length=$packet_length$&form.myDNSLookup=$myDNSLookup$&form.my_cust=$my_cust$
]]>
        </link>
      </drilldown>
    </table>
  </row>
  <row>
    <table>
      <title>Servers Involved in Security Events</title>
      <searchString>$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=$myAct$ srvgrp=$server_group$ plen=$packet_length$ cust=$my_cust$
| stats sparkline(count(rule),10m) as sparkline values(hostname) as Hostname count(rule) as "# of Events" dc(sip) as sip_count values(prot) as "IP Protocols Used" dc(dprt) as myprot_count dc(rule) as atck_count values(srvgrp) as "Server Group" by dip
| makemv delim="," "IP Protocols Used"
| sort - "# of Events"
| lookup $myDNSLookup$ clientip as dip
| table dip, clienthost, Hostname, "Server Group", "# of Events", sip_count, "IP Protocols Used", myprot_count, atck_count, sparkline
| rename dip as "Server_IP_Address", sip_count as "# of Client IP Addresses", myprot_count as "Ports Accessed", atck_count as "Rules Blocking Traffic", clienthost as "Hostname", sparkline as "Mitigation Activity Sparkline"</searchString>
      <option name="charting.axisTitleX.visibility">visible</option>
      <option name="charting.axisTitleY.visibility">visible</option>
      <option name="charting.axisX.scale">linear</option>
      <option name="charting.axisY.scale">linear</option>
      <option name="charting.chart">line</option>
      <option name="charting.chart.nullValueMode">gaps</option>
      <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
      <option name="charting.chart.stackMode">default</option>
      <option name="charting.chart.style">shiny</option>
      <option name="charting.drilldown">all</option>
      <option name="charting.layout.splitSeries">0</option>
      <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
      <option name="charting.legend.placement">right</option>
      <option name="wrap">true</option>
      <option name="rowNumbers">false</option>
      <option name="dataOverlayMode">none</option>
      <option name="drilldown">cell</option>
      <format type="sparkline" field="Mitigation Activity Sparkline">
        <option name="maxSpotColor">#A2FFA2</option>
        <option name="lineWidth">1</option>
        <option name="height">25px</option>
        <option name="spotRadius">3</option>
        <option name="fillColor">#CCDDFF</option>
        <option name="lineColor">#5379af</option>
      </format>
      <drilldown>
        <link>
          <![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.server_IP=$row.Server_IP_Address$&form.deployment=$deployment$&form.client_IP=$client_IP$&form.corero_rule=$corero_rule$&form.server_port=$server_port$&form.myProt=$myProt$&form.client_port=$client_port$&form.myDir=$myDir$&form.myAct=$myAct$&form.server_group=$server_group$&form.packet_length=$packet_length$&form.myDNSLookup=$myDNSLookup$&form.my_cust=$my_cust$
    ]]>
        </link>
      </drilldown>
    </table>
  </row>
  <row>
    <table>
      <title>Server Ports Involved in Security Events</title>
      <searchString>$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=$myAct$ srvgrp=$server_group$ plen=$packet_length$ cust=$my_cust$
| stats sparkline(count(rule),10m) as sparkline count(rule) as "# of Events" dc(sip) as "# of Client IP's" dc(dip) as "# of Server IP's" values(prot) as "IP Protocols Used" dc(rule) as "Rules Blocking Traffic" by dprt
| makemv delim="," "IP Protocols Used"
| table dprt, "# of Events", "# of Client IP's", "# of Server IP's", "IP Protocols Used", "Rules Blocking Traffic", sparkline
| sort - "# of Events"
| table dprt, "# of Events", "# of Client IP's", "# of Server IP's", "IP Protocols Used", "Rules Blocking Traffic", sparkline
| rename dprt as "Server_Port", sparkline as "Mitigation Activity Sparkline"</searchString>
      <option name="charting.axisTitleX.visibility">visible</option>
      <option name="charting.axisTitleY.visibility">visible</option>
      <option name="charting.axisX.scale">linear</option>
      <option name="charting.axisY.scale">linear</option>
      <option name="charting.chart">line</option>
      <option name="charting.chart.nullValueMode">gaps</option>
      <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
      <option name="charting.chart.stackMode">default</option>
      <option name="charting.chart.style">shiny</option>
      <option name="charting.drilldown">all</option>
      <option name="charting.layout.splitSeries">0</option>
      <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
      <option name="charting.legend.placement">right</option>
      <option name="wrap">true</option>
      <option name="rowNumbers">false</option>
      <option name="dataOverlayMode">none</option>
      <option name="drilldown">cell</option>
      <format type="sparkline" field="Mitigation Activity Sparkline">
        <option name="maxSpotColor">#A2FFA2</option>
        <option name="lineWidth">1</option>
        <option name="height">25px</option>
        <option name="spotRadius">3</option>
        <option name="fillColor">#CCDDFF</option>
        <option name="lineColor">#5379af</option>
      </format>
      <drilldown>
        <link>
          <![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.server_IP=$server_IP$&form.deployment=$deployment$&form.client_IP=$client_IP$&form.corero_rule=$corero_rule$&form.server_port=$row.Server_Port$&form.myProt=$myProt$&form.client_port=$client_port$&form.myDir=$myDir$&form.myAct=$myAct$&form.server_group=$server_group$&form.packet_length=$packet_length$&form.myDNSLookup=$myDNSLookup$&form.my_cust=$my_cust$
]]>
        </link>
      </drilldown>
    </table>
  </row>
  <row>
    <table>
      <title>Clients Involved in Security Events</title>
      <searchString>$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=$myAct$ srvgrp=$server_group$ plen=$packet_length$ cust=$my_cust$
| stats sparkline(count(rule),10m) as sparkline values(hostname) as Hostname count(rule) as "# of Events" dc(dip) as dip_count dc(dprt) as myprot_count dc(rule) as atck_count by sip
| sort - "# of Events"
| iplocation sip
| lookup $myDNSLookup$ clientip as sip
| table sip, clienthost, Hostname, Country, "# of Events", dip_count, myprot_count, atck_count, sparkline
| rename sip as "Client_IP", dip_count as "Servers Accessed", myprot_count as "Protocols Used", atck_count as "Rules Blocking Traffic", clienthost as "Hostname", sparkline as "Mitigation Activity Sparkline"</searchString>
      <option name="charting.axisTitleX.visibility">visible</option>
      <option name="charting.axisTitleY.visibility">visible</option>
      <option name="charting.axisX.scale">linear</option>
      <option name="charting.axisY.scale">linear</option>
      <option name="charting.chart">line</option>
      <option name="charting.chart.nullValueMode">gaps</option>
      <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
      <option name="charting.chart.stackMode">default</option>
      <option name="charting.chart.style">shiny</option>
      <option name="charting.drilldown">all</option>
      <option name="charting.layout.splitSeries">0</option>
      <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
      <option name="charting.legend.placement">right</option>
      <option name="wrap">true</option>
      <option name="rowNumbers">false</option>
      <option name="dataOverlayMode">none</option>
      <option name="drilldown">cell</option>
      <format type="sparkline" field="Mitigation Activity Sparkline">
        <option name="maxSpotColor">#A2FFA2</option>
        <option name="lineWidth">1</option>
        <option name="height">25px</option>
        <option name="spotRadius">3</option>
        <option name="fillColor">#CCDDFF</option>
        <option name="lineColor">#5379af</option>
      </format>
      <drilldown>
        <link>
          <![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.client_IP=$row.Client_IP$&form.deployment=$deployment$&form.server_IP=$server_IP$&form.corero_rule=$corero_rule$&form.server_port=$server_port$&form.myProt=$myProt$&form.client_port=$client_port$&form.myDir=$myDir$&form.myAct=$myAct$&form.server_group=$server_group$&form.packet_length=$packet_length$&form.myDNSLookup=$myDNSLookup$&form.my_cust=$my_cust$
]]>
        </link>
      </drilldown>
    </table>
  </row>
  <row>
    <table>
      <title>Client Ports Involved in Security Events</title>
      <searchString>$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=$myAct$ srvgrp=$server_group$ plen=$packet_length$ cust=$my_cust$
| stats sparkline(count(rule),10m) as sparkline count(rule) as "# of Events" dc(sip) as "# of Client IP's" dc(dip) as "# of Server IP's" values(prot) as "IP Protocols Used" dc(rule) as "Rules Blocking Traffic" by sprt
| makemv delim="," "IP Protocols Used"
| table sprt, "# of Events", "# of Client IP's", "# of Server IP's", "IP Protocols Used", "Rules Blocking Traffic", sparkline
| sort - "# of Events"
| table sprt, "# of Events", "# of Client IP's", "# of Server IP's", "IP Protocols Used", "Rules Blocking Traffic", sparkline
| rename sprt as "Client_Port", sparkline as "Mitigation Activity Sparkline"</searchString>
      <option name="charting.axisTitleX.visibility">visible</option>
      <option name="charting.axisTitleY.visibility">visible</option>
      <option name="charting.axisX.scale">linear</option>
      <option name="charting.axisY.scale">linear</option>
      <option name="charting.chart">line</option>
      <option name="charting.chart.nullValueMode">gaps</option>
      <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
      <option name="charting.chart.stackMode">default</option>
      <option name="charting.chart.style">shiny</option>
      <option name="charting.drilldown">all</option>
      <option name="charting.layout.splitSeries">0</option>
      <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
      <option name="charting.legend.placement">right</option>
      <option name="wrap">true</option>
      <option name="rowNumbers">false</option>
      <option name="dataOverlayMode">none</option>
      <option name="drilldown">cell</option>
      <format type="sparkline" field="Mitigation Activity Sparkline">
        <option name="maxSpotColor">#A2FFA2</option>
        <option name="lineWidth">1</option>
        <option name="height">25px</option>
        <option name="spotRadius">3</option>
        <option name="fillColor">#CCDDFF</option>
        <option name="lineColor">#5379af</option>
      </format>
      <drilldown>
        <link>
          <![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.server_IP=$server_IP$&form.deployment=$deployment$&form.client_IP=$client_IP$&form.corero_rule=$corero_rule$&form.server_port=$server_port$&form.myProt=$myProt$&form.client_port=$row.Client_Port$&form.myDir=$myDir$&form.myAct=$myAct$&form.server_group=$server_group$&form.packet_length=$packet_length$&form.myDNSLookup=$myDNSLookup$&form.my_cust=$my_cust$
]]>
        </link>
      </drilldown>
    </table>
  </row>
  <row>
    <table>
      <title>Packet Lengths Involved in Security Events</title>
      <searchString>$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=$myAct$ srvgrp=$server_group$ plen=$packet_length$ cust=$my_cust$
| stats sparkline(count(rule),10m) as sparkline count(rule) as "# of Events" dc(sip) as "# of Client IP's" dc(dip) as "# of Server IP's" values(prot) as "IP Protocols Used" dc(rule) as "Rules Blocking Traffic" by plen
| makemv delim="," "IP Protocols Used"
| table plen, "# of Events", "# of Client IP's", "# of Server IP's", "IP Protocols Used", "Rules Blocking Traffic", sparkline
| sort - "# of Events"
| table plen, "# of Events", "# of Client IP's", "# of Server IP's", "IP Protocols Used", "Rules Blocking Traffic", sparkline
| rename plen as "Packet_Length", sparkline as "Mitigation Activity Sparkline"</searchString>
      <option name="charting.axisTitleX.visibility">visible</option>
      <option name="charting.axisTitleY.visibility">visible</option>
      <option name="charting.axisX.scale">linear</option>
      <option name="charting.axisY.scale">linear</option>
      <option name="charting.chart">line</option>
      <option name="charting.chart.nullValueMode">gaps</option>
      <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
      <option name="charting.chart.stackMode">default</option>
      <option name="charting.chart.style">shiny</option>
      <option name="charting.drilldown">all</option>
      <option name="charting.layout.splitSeries">0</option>
      <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
      <option name="charting.legend.placement">right</option>
      <option name="wrap">true</option>
      <option name="rowNumbers">false</option>
      <option name="dataOverlayMode">none</option>
      <option name="drilldown">cell</option>
      <format type="sparkline" field="Mitigation Activity Sparkline">
        <option name="maxSpotColor">#A2FFA2</option>
        <option name="lineWidth">1</option>
        <option name="height">25px</option>
        <option name="spotRadius">3</option>
        <option name="fillColor">#CCDDFF</option>
        <option name="lineColor">#5379af</option>
      </format>
      <drilldown>
        <link>
          <![CDATA[
event_drilldown?earliest=$earliest$&latest=$latest$&form.server_IP=$server_IP$&form.deployment=$deployment$&form.client_IP=$client_IP$&form.corero_rule=$corero_rule$&form.server_port=$server_port$&form.myProt=$myProt$&form.client_port=$client_port$&form.myDir=$myDir$&form.myAct=$myAct$&form.server_group=$server_group$&form.packet_length=$row.Packet_Length$&form.myDNSLookup=$myDNSLookup$&form.my_cust=$my_cust$
]]>
        </link>
      </drilldown>
    </table>
  </row>
  <row>
    <table>
      <title>Syslog Events</title>
      <searchString>$deployment$ cat=security type=event rule=$corero_rule$ sip=$client_IP$ dip=$server_IP$ dprt=$server_port$ prot=$myProt$ sprt=$client_port$ dir=$myDir$ act=$myAct$ srvgrp=$server_group$ plen=$packet_length$ cust=$my_cust$
        | table _raw
        | head 300
        | rename _raw as "Syslog Message"</searchString>
    </table>
  </row>
</form>
