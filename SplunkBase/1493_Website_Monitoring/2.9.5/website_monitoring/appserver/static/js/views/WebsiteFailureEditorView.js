define(["underscore","backbone","splunkjs/mvc","jquery","splunkjs/mvc/simplesplunkview","splunkjs/mvc/simpleform/input/text","splunkjs/mvc/simpleform/input/dropdown","splunkjs/mvc/utils","util/splunkd_utils"],function(i,h,c,d,f,e,a,g,b){return f.extend({className:"WebsiteFailureEditorView",apps:null,RESPONSE_TIME_THRESHOLD:"response_time_threshold",RESPONSE_TIME_THRESHOLD_WARNING:"response_time_threshold_warning",RESPONSE_RESPONSE_CODES_TO_ALERT_ON:"response_codes_to_alert_on",defaults:{},initialize:function(){this.options=i.extend({},this.defaults,this.options);options=this.options||{};this.already_rendered=false;this.response_time_macro=null;this.response_code_macro=null},loadMacrosIntoForm:function(){if(c.Components.getInstance("response-threshold-input")!==null){c.Components.getInstance("response-threshold-input").val(this.response_time_macro.content.definition)}if(c.Components.getInstance("response-code-input")!==null){c.Components.getInstance("response-code-input").val(this.response_code_macro.content.definition)}},events:{"click #save":"save","click #open-settings-modal":"clickOpenModal"},getMacro:function(j){var k=jQuery.Deferred();if(this.app_name===null||this.app_name===undefined){this.app_name=g.getCurrentApp()}fetch(b.fullpath("/servicesNS/nobody/"+this.app_name+"/data/macros/"+j+"?output_mode=json")).then(function(l){return l.json()}).then(function(l){k.resolve(l.entry[0])});return k},setMacroDefinition:function(k,l){var j=document.cookie.match(/splunkweb_csrf_token_8000=(\d+)/)[1];var m=new URLSearchParams();m.append("definition",l);fetch(b.fullpath("/servicesNS/nobody/"+this.app_name+"/data/macros/"+k+"?output_mode=json"),{method:"POST",headers:{"Content-Type":"Content-Type: application/x-www-form-urlencoded; charset=UTF-8","X-Splunk-Form-Key":j,"X-Requested-With":"XMLHttpRequest"},body:m.toString()}).then(function(n){return n.json()}).then(function(n){promise.resolve(n.entry[0])})},saveMacroModel:function(k,j){k.entry.content.set({definition:j},{silent:true});return k.save()},getControls:function(){return'<div class="controls" style="margin-top: 12px"><a href="#" class="btn btn-primary" id="save" style="display: inline;">Save</a></div>'},getModalTemplate:function(k,j){return'<div tabindex="-1" id="threshold-modal" class="modal fade in hide"><div class="modal-header"><button type="button" class="close btn-dialog-close" data-dismiss="modal">x</button><h3 class="text-dialog-title">'+k+'</h3></div><div class="modal-body form form-horizontal modal-body-scrolling">'+j+'</div><div class="modal-footer"><a href="#" class="btn btn-dialog-cancel" data-dismiss="modal" style="display: inline;">Close</a><a href="#" class="btn btn-primary" id="save" style="display: inline;">Save</a> </div></div>'},makeInputTemplate:function(j,l,k){return'<div id="'+l+'-control-group" class="control-group">	<label class="control-label">'+j+'</label>		<div class="controls">			<div style="display: inline-block;" class="input" id="'+l+'" />			<span class="hide help-inline"></span>			<span class="help-block"> '+k+"</span>		</div></div>"},getInputTemplate:function(){return'<div style="display:none" id="warning_message_dialog"><div class="alert alert-error"><i class="icon-alert"></i><span id="warning_message"></span></div></div><div style="display:none" id="success_message_dialog"><div class="alert alert-info"><i class="icon-alert"></i><span id="success_message"></span></div></div><span id="settings_form"><div>You define what you want to consider an outage below. These settings will also apply to the <a class="external" target="external" href="alert?s=%2FservicesNS%2Fnobody%2Fwebsite_monitoring%2Fsaved%2Fsearches%2FWebsite%2520Performance%2520Problem">alert search</a> that provides notifications of outages.</div><div style="margin-bottom: 16px"></div><div class="input" id="response-threshold-input"><label>Error Response Time Threshold (in milliseconds)</label></div><div style="margin-top: 24px" class="input" id="response-code-input"><label>Response Codes Considered Failures</label></div></span>'},showSuccessMessage:function(j){this.hideMessage();d("#success_message_dialog",this.$el).show();d("#success_message",this.$el).text(j)},showFailureMessage:function(j){this.hideMessage();d("#warning_message_dialog",this.$el).show();d("#warning_message",this.$el).text(j)},hideMessage:function(){d("#success_message_dialog",this.$el).hide();d("#warning_message_dialog",this.$el).hide()},validate:function(){var j=this.getValidationMessage();if(j===true){this.hideMessage()}else{this.showFailureMessage(j)}},getValidationMessage:function(){var j=0;if(!/([0-9])+$/gi.test(c.Components.getInstance("response-threshold-input").val())){return"The threshold is not valid (must be a integer greater than zero)"}return j===0},startRendering:function(){var j=[this.getMacro(this.RESPONSE_TIME_THRESHOLD),this.getMacro(this.RESPONSE_TIME_THRESHOLD_WARNING),this.getMacro(this.RESPONSE_RESPONSE_CODES_TO_ALERT_ON)];d.when.apply(d,j).done(function(k,l,m){this.response_code_macro=m;this.response_time_macro=k;this.response_time_warning_macro=l;this.completeRender()}.bind(this))},render:function(){this.startRendering()},completeRender:function(){if(!this.already_rendered){if(this.response_time_macro.acl.can_write&&this.response_time_warning_macro.acl.can_write&&this.response_code_macro.acl.can_write){var k='<a id="open-settings-modal" href="#">Modify the definition of a failure</a>';k=k+this.getModalTemplate("Failure Definition",this.getInputTemplate());this.$el.html(k);var l=new e({id:"response-threshold-input",searchWhenChanged:false,el:d("#response-threshold-input",this.$el)},{tokens:false}).render();l.on("change",function(m){this.validate()}.bind(this));var j=new a({id:"response-code-input",searchWhenChanged:false,el:d("#response-code-input",this.$el),choices:[{label:"400 and 500 response codes",value:"response_code>=400"},{label:"500 response codes",value:"response_code>=500"},{label:"400 and 500 response codes, but not 404",value:"(response_code>=400 AND response_code!=404)"},{label:"300, 400 and 500 response codes",value:"response_code>=300"}]},{tokens:false}).render();j.onInputReady=function(){};l.onInputReady=function(){};this.loadMacrosIntoForm()}else{this.$el.html("")}this.already_rendered=true}return this},clickOpenModal:function(){this.showModal()},showModal:function(){this.render();this.hideMessage();d("#threshold-modal",this.$el).modal()},showSaving:function(j){if(typeof j==="undefined"){j=true}if(j){d("#save",this.$el).prop("disabled",false);d("#save",this.$e).addClass("disabled")}else{d("#save",this.$el).removeProp("disabled");d("#save",this.$e).removeClass("disabled")}},save:function(){this.showSaving();d.when(this.setMacroDefinition(this.RESPONSE_TIME_THRESHOLD,c.Components.getInstance("response-threshold-input").val())).then(this.setMacroDefinition(this.RESPONSE_RESPONSE_CODES_TO_ALERT_ON,c.Components.getInstance("response-code-input").val())).done(function(){this.showSaving(false);d("#threshold-modal",this.$el).modal("hide")}.bind(this)).fail(function(){this.showSaving(false);this.showFailureMessage("Configuration could not be changed")}.bind(this))}})});