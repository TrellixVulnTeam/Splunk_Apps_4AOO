##
## SPDX-FileCopyrightText: 2021 Splunk, Inc. <sales@splunk.com>
## SPDX-License-Identifier: LicenseRef-Splunk-1-2020
##
##
[source::...wsa.access]
sourcetype = cisco:wsa:squid

[cisco:wsa:squid]
KV_MODE = none
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
TRANSFORMS-TrashHeaders = TrashHeaders
REPORT-extract = kv_for_cisco_wsa_squid,cs_url_host,acltag_action,url_domain

EVAL-date = strftime(_time, "%m/%d/%Y")
FIELDALIAS-src = src_ip AS src
EVAL-scanning_engine = if(isnotnull(x_webroot_threat_name),"Webroot",if(isnotnull(x_sophos_virus_name),"Sophos",if(isnotnull(x_mcafee_virus_name),"Mcafee",if(isnotnull(x_amp_malware_name),"Advanced Malware Protection","Unknown"))))
FIELDALIAS-vendor_action = txn_result_code AS vendor_action
EVAL-bytes = if(isnotnull(bytes_in) and isnotnull(bytes_out) and isnum(bytes_out), bytes_in + bytes_out, if(isnotnull(bytes_in), bytes_in, null()))
FIELDALIAS-CSS_compatibility = wbrs_score AS x_wbrs_score user AS cs_username txn_result_code AS http_result
EVAL-vendor = "Cisco"
EVAL-product = "WSA"
EVAL-vendor_product = "Cisco WSA"
EVAL-ids_type = "network"
LOOKUP-code_info = cisco_wsa_category_lookup x_webcat_code_abbr OUTPUT webcat_code_full AS vendor_category, webcat_code_full AS x_webcat_code_full,usage,severity
LOOKUP-malware_action = cisco_wsa_malware_action_lookup x_webroot_scanverdict OUTPUT malware_action
EVAL-http_user_agent = coalesce(http_user_agent,vendor_suspect_user_agent)
FIELDALIAS-category = x_resp_dvs_threat_name as category
EVAL-http_user_agent_length = if(isnotnull(http_user_agent), len(http_user_agent), len(vendor_suspect_user_agent))

FIELDALIAS-wbrs_score = wbrs_score as x_wbrs_score
FIELDALIAS-webroot_threat_name = webroot_threat_name as x_webroot_threat_name
FIELDALIAS-hierarchy = server_contact_mode as hierarchy
EVAL-signature = case(isnotnull(x_mcafee_virus_name),x_mcafee_virus_name,isnotnull(x_webroot_threat_name),x_webroot_threat_name,isnotnull(x_sophos_virus_name),x_sophos_virus_name,isnotnull(x_req_dvs_threat_name),x_req_dvs_threat_name,isnotnull(x_resp_dvs_threat_name),x_resp_dvs_threat_name,1=1,"Unknown")
FIELDALIAS-file_hash = x_amp_sha as file_hash
EVAL-file_name = coalesce(x_mcafee_filename,x_sophos_file_name,x_amp_filename)
EVAL-cached = case(match(txn_result_code,"TCP_HIT") OR match(txn_result_code, "TCP_IMS_HIT") OR match(txn_result_code, "TCP_MEM_HIT") OR match(txn_result_code, "TCP_REFRESH_HIT"), 1, match(txn_result_code,"TCP_MISS") OR match(txn_result_code, "TCP_CLIENT_REFRESH_MISS") OR match(txn_result_code, "TCP_DENIED") OR match(txn_result_code, "NONE"), 0)
FIELDALIAS-duration = x_elapsed_time as duration
EVAL-url_length = len(url)
LOOKUP-proxy_action = cisco_wsa_proxy_action_lookup acl_action OUTPUT ta_cisco_wsa_proxy_action, ta_cisco_wsa_proxy_action as action
EVAL-dest = if(isnull(dest), cs_url_host, dest)
FIELDALIAS-x_acltag = acltag as x_acltag
FIELDALIAS-dvc = host as dvc
EVAL-malware_action= case(isnull(x_webroot_scanverdict),"allowed",true(), malware_action)
pulldown_type = true
category = Network & Security
description = Output produced by the Cisco Web Security Appliance(WSA)

#######L4TM logs#######
[source::...wsa.l4tm]
sourcetype = cisco:wsa:l4tm

[cisco:wsa:l4tm]
KV_MODE = none
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
REPORT-extract = kv_for_cisco_wsa_Firewall_l4tm,kv_for_cisco_wsa_Address_l4tm,kv_for_cisco_wsa_removed_l4tm,kv_for_cisco_wsa_Firewall_l4tm_timezone,kv_for_cisco_wsa_Address_l4tm_timezone,kv_for_cisco_wsa_removed_l4tm_timezone
EVAL-vendor = "Cisco"
EVAL-product = "WSA"
EVAL-vendor_product = "Cisco WSA"
EVAL-ids_type = "network"
EVAL-ta_cisco_wsa_traffic_vendor_action = vendor_action
LOOKUP-vendor_traffic_action = cisco_wsa_traffic_action_lookup ta_cisco_wsa_traffic_vendor_action OUTPUT ta_cisco_wsa_traffic_action, ta_cisco_wsa_traffic_action as action
FIELDALIAS-dest_host = dest_domain as dest_host
FIELDALIAS-dest_ip = dest as dest_ip
FIELDALIAS-src_ip = src as src_ip
pulldown_type = true
category = Network & Security
description = Output produced by the Cisco Web Security Appliance(WSA)
FIELDALIAS-dvc = host as dvc
EVAL-protocol = "IP"

#######access logs in w3c format#######
[cisco:wsa:w3c]
KV_MODE = none
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
pulldown_type = true
category = Network & Security
description = Output produced by the Cisco Web Security Appliance(WSA) in W3C format
TRANSFORMS-TrashHeaders = TrashHeaders
REPORT-extract = auto_kv_for_cisco_wsa_w3c,x_acltag_action,result_code_extract,contact_mode_extract,scan_verdict_info_extract,cs_url_host, url_domain

EVAL-date = strftime(_time, "%m/%d/%Y")
FIELDALIAS-src = src_ip AS src
EVAL-scanning_engine = if(x_webroot_threat_name!="-","Webroot",if(x_sophos_virus_name!="-","Sophos",if(x_mcafee_virus_name!="-","Mcafee",if(x_amp_malware_name!="-","Advanced Malware Protection","Unknown"))))
FIELDALIAS-vendor_action = txn_result_code AS vendor_action
EVAL-bytes = if(bytes_in!="-" and bytes_in!="" and bytes_out!="-" and bytes_out!="" and isnum(bytes_out), bytes_in + bytes_out, if(bytes_in!="-" and bytes_in!="", bytes_in, null()))
FIELDALIAS-CSS_compatibility = wbrs_score AS x_wbrs_score user AS cs_username txn_result_code AS http_result
EVAL-vendor = "Cisco"
EVAL-product = "WSA"
EVAL-vendor_product = "Cisco WSA"
EVAL-ids_type = "network"
LOOKUP-code_info = cisco_wsa_category_lookup x_webcat_code_abbr OUTPUT webcat_code_full AS vendor_category, webcat_code_full AS x_webcat_code_full,usage,severity
LOOKUP-malware_action = cisco_wsa_malware_action_lookup x_webroot_scanverdict OUTPUT malware_action
EVAL-http_user_agent=coalesce(http_user_agent,vendor_suspect_user_agent)
FIELDALIAS-category = x_resp_dvs_threat_name as category
EVAL-http_user_agent_length = if(http_user_agent!="-", len(http_user_agent), len(vendor_suspect_user_agent))

FIELDALIAS-wbrs_score = wbrs_score as x_wbrs_score
FIELDALIAS-webroot_threat_name = webroot_threat_name as x_webroot_threat_name
FIELDALIAS-hierarchy = server_contact_mode as hierarchy
EVAL-signature = case(x_mcafee_virus_name!="-",x_mcafee_virus_name,x_webroot_threat_name!="-",x_webroot_threat_name,x_sophos_virus_name!="-",x_sophos_virus_name,x_req_dvs_threat_name!="-",x_req_dvs_threat_name,x_resp_dvs_threat_name!="-",x_resp_dvs_threat_name,1=1,"Unknown")
EVAL-file_hash = case(x_amp_sha!="-",x_amp_sha)
EVAL-file_name = case(x_mcafee_filename!="-",x_mcafee_filename,x_sophos_file_name!="-",x_sophos_file_name,x_amp_filename!="-",x_amp_filename)
EVAL-cached = case(match(txn_result_code,"TCP_HIT") OR match(txn_result_code, "TCP_IMS_HIT") OR match(txn_result_code, "TCP_MEM_HIT") OR match(txn_result_code, "TCP_REFRESH_HIT"), 1, match(txn_result_code,"TCP_MISS") OR match(txn_result_code, "TCP_CLIENT_REFRESH_MISS") OR match(txn_result_code, "TCP_DENIED") OR match(txn_result_code, "NONE"), 0)
FIELDALIAS-duration = x_elapsed_time as duration
EVAL-url_length = len(url)
LOOKUP-proxy_action = cisco_wsa_proxy_action_lookup acl_action OUTPUT ta_cisco_wsa_proxy_action, ta_cisco_wsa_proxy_action as action
EVAL-dest = if(isnull(dest) OR dest="-", cs_url_host, dest)
EVAL-bytes_out = if(isnum(bytes_out), bytes_out, null())
EVAL-malware_action= case(x_webroot_scanverdict!="-","allowed",true(), malware_action)
FIELDALIAS-dvc = host as dvc

[cisco:wsa:squid:new]
KV_MODE = none
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
TRANSFORMS-TrashHeaders = TrashHeaders

EVAL-date = strftime(_time, "%m/%d/%Y")
FIELDALIAS-src = src_ip AS src
EVAL-scanning_engine = if(isnotnull(x_webroot_threat_name),"Webroot",if(isnotnull(x_sophos_virus_name),"Sophos",if(isnotnull(x_mcafee_virus_name),"Mcafee",if(isnotnull(x_amp_malware_name),"Advanced Malware Protection","Unknown"))))
FIELDALIAS-vendor_action = txn_result_code AS vendor_action
EVAL-bytes = if(isnotnull(bytes_in) and isnotnull(bytes_out) and isnum(bytes_out), bytes_in + bytes_out, if(isnotnull(bytes_in), bytes_in, null()))
FIELDALIAS-CSS_compatibility = wbrs_score AS x_wbrs_score user AS cs_username txn_result_code AS http_result
EVAL-vendor = "Cisco"
EVAL-product = "WSA"
EVAL-vendor_product = "Cisco WSA"
EVAL-ids_type = "network"
LOOKUP-code_info = cisco_wsa_category_lookup x_webcat_code_abbr OUTPUT webcat_code_full AS vendor_category, webcat_code_full AS x_webcat_code_full,usage,severity
LOOKUP-malware_action = cisco_wsa_malware_action_lookup x_webroot_scanverdict OUTPUT malware_action
EVAL-http_user_agent = coalesce(http_user_agent,vendor_suspect_user_agent)
FIELDALIAS-category = x_resp_dvs_threat_name as category
EVAL-http_user_agent_length = if(isnotnull(http_user_agent), len(http_user_agent), len(vendor_suspect_user_agent))

FIELDALIAS-wbrs_score = wbrs_score as x_wbrs_score
FIELDALIAS-webroot_threat_name = webroot_threat_name as x_webroot_threat_name
FIELDALIAS-hierarchy = server_contact_mode as hierarchy
EVAL-signature = case(isnotnull(x_mcafee_virus_name),x_mcafee_virus_name,isnotnull(x_webroot_threat_name),x_webroot_threat_name,isnotnull(x_sophos_virus_name),x_sophos_virus_name,isnotnull(x_req_dvs_threat_name),x_req_dvs_threat_name,isnotnull(x_resp_dvs_threat_name),x_resp_dvs_threat_name,1=1,"Unknown")
FIELDALIAS-file_hash = x_amp_sha as file_hash
EVAL-file_name = coalesce(x_mcafee_filename,x_sophos_file_name,x_amp_filename)
EVAL-cached = case(match(txn_result_code,"TCP_HIT") OR match(txn_result_code, "TCP_IMS_HIT") OR match(txn_result_code, "TCP_MEM_HIT") OR match(txn_result_code, "TCP_REFRESH_HIT"), 1, match(txn_result_code,"TCP_MISS") OR match(txn_result_code, "TCP_CLIENT_REFRESH_MISS") OR match(txn_result_code, "TCP_DENIED") OR match(txn_result_code, "NONE"), 0)
FIELDALIAS-duration = x_elapsed_time as duration
EVAL-url_length = len(url)
LOOKUP-proxy_action = cisco_wsa_proxy_action_lookup acl_action OUTPUT ta_cisco_wsa_proxy_action, ta_cisco_wsa_proxy_action as action
EVAL-dest = if(isnull(dest), cs_url_host, dest)
FIELDALIAS-x_acltag = acltag as x_acltag
FIELDALIAS-dvc = host as dvc
EVAL-malware_action= case(isnull(x_webroot_scanverdict),"allowed",true(), malware_action)
pulldown_type = true
category = Network & Security
description = Output produced by the Cisco Web Security Appliance(WSA)

[cisco:wsa:w3c:recommended]
KV_MODE = none
SHOULD_LINEMERGE = false
EVENT_BREAKER_ENABLE = true
pulldown_type = true
category = Network & Security
description = Output produced by the Cisco Web Security Appliance(WSA) in W3C format
TRANSFORMS-TrashHeaders = TrashHeaders
REPORT-extract = auto_kv_for_cisco_wsa_w3c_12_5, x_acltag_action, result_code_extract, cs_url_host, http_referrer_domain, url_domain
SEDCMD-empty = s/\s-/ ""/g
SEDCMD-empty_quotes = s/\s["|']-["|']/ ""/g

EVAL-date = strftime(_time, "%m/%d/%Y")
FIELDALIAS-dest_port = s_port AS dest_port
EVAL-src = if(isnotnull(X_Forwarded_For) AND X_Forwarded_For!="::", X_Forwarded_For, c_ip)
EVAL-scanning_engine = if(isnotnull(x_webroot_threat_name),"Webroot",if(isnotnull(x_sophos_virus_name),"Sophos",if(isnotnull(x_mcafee_virus_name),"Mcafee",if(isnotnull(x_amp_malware_name),"Advanced Malware Protection","Unknown"))))
FIELDALIAS-vendor_action = txn_result_code AS vendor_action
EVAL-bytes = if(isnotnull(bytes_in) and isnotnull(bytes_out) and isnum(bytes_out), bytes_in + bytes_out, if(isnotnull(bytes_in), bytes_in, null()))
FIELDALIAS-CSS_compatibility = wbrs_score AS x_wbrs_score user AS cs_username txn_result_code AS http_result
EVAL-vendor = "Cisco"
EVAL-product = "WSA"
EVAL-vendor_product = "Cisco WSA"
EVAL-ids_type = "network"
LOOKUP-code_info = cisco_wsa_category_lookup x_webcat_code_abbr OUTPUT webcat_code_full AS vendor_category, webcat_code_full AS x_webcat_code_full,usage,severity
LOOKUP-malware_action = cisco_wsa_malware_action_lookup x_webroot_scanverdict OUTPUT malware_action
EVAL-http_user_agent = coalesce(http_user_agent,vendor_suspect_user_agent)
EVAL-http_user_agent_length = if(isnotnull(http_user_agent), len(http_user_agent), len(vendor_suspect_user_agent))

FIELDALIAS-wbrs_score = wbrs_score as x_wbrs_score
FIELDALIAS-webroot_threat_name = webroot_threat_name as x_webroot_threat_name
EVAL-signature = case(isnotnull(x_mcafee_virus_name),x_mcafee_virus_name,isnotnull(x_webroot_threat_name),x_webroot_threat_name,isnotnull(x_sophos_virus_name),x_sophos_virus_name,isnotnull(x_req_dvs_threat_name),x_req_dvs_threat_name,isnotnull(x_resp_dvs_threat_name),x_resp_dvs_threat_name,1=1,"Unknown")
EVAL-file_hash = case(isnotnull(x_amp_sha),x_amp_sha)
EVAL-file_name = coalesce(x_mcafee_filename,x_sophos_file_name,x_amp_filename)
EVAL-cached = case(match(txn_result_code,"TCP_HIT") OR match(txn_result_code, "TCP_IMS_HIT") OR match(txn_result_code, "TCP_MEM_HIT") OR match(txn_result_code, "TCP_REFRESH_HIT"), 1, match(txn_result_code,"TCP_MISS") OR match(txn_result_code, "TCP_CLIENT_REFRESH_MISS") OR match(txn_result_code, "TCP_DENIED") OR match(txn_result_code, "NONE"), 0)
FIELDALIAS-duration = x_elapsed_time as duration
EVAL-url_length = len(url)
LOOKUP-proxy_action = cisco_wsa_proxy_action_lookup acl_action OUTPUT ta_cisco_wsa_proxy_action, ta_cisco_wsa_proxy_action as action
EVAL-dest = if(isnull(dest), cs_url_host, dest)
EVAL-bytes_out = if(isnum(bytes_out), bytes_out, null())
FIELDALIAS-category = x_resp_dvs_threat_name as category
FIELDALIAS-dvc = host as dvc
EVAL-malware_action= case(isnull(x_webroot_scanverdict),"allowed",true(), malware_action)

[source::...wsa_11.7]
sourcetype = cisco:wsa:squid:new
REPORT-extract = kv_for_cisco_wsa_squid_11_7,cs_url_host,acltag_action,url_domain
